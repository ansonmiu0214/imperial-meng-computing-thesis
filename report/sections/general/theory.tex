\chapter{\newtheory: A Theory of
Routed Multiparty Session Types}
\label{chap:theory}

In this chapter, we present
\newtheory, an extension of the
canonical multiparty session type (MPST)
theory with a message routing mechanism.
We build upon the variant of MPST theory introduced
in \cite{LessIsMore}
(which we have also discussed in \cref{subsection:bgmpst}), 
and extend it
with constructs for communication actions
that are routed through a participant.

\newtheory provide the theoretical basis
for allowing developers to implement
protocols with browser-to-browser interactions
(such as the \tprotocol{Two Buyer} protocol
introduced in \cref{section:twobuyer})
over a server-centric network topology
which uses WebSocket transport.
We introduce the extended syntax for types in 
\cref{section:syntax}, and give semantics of our
syntax extensions in \cref{section:lts}.
Regarding the extended semantics on routed session types,
we prove the soundness and completeness of
the extended semantics in \cref{section:newtraceeq}.
In \cref{section:encoding},
we define a router-parameterised encoding
for canonical MPST theory into \newtheory
and prove the preservation of well-formedness
and communication.
We proceed to extend \codegen to implement \newtheory
in \cref{chap:impl}.

\input{sections/general/theory/syntax}

\input{sections/general/theory/lts}

\input{sections/general/theory/soundcomplete}

\input{sections/general/theory/encoding}

\section{Summary}
We have presented \newtheory, a variant of
the canonical MPST theory to express \textit{routed communication}.
We introduced extensions to syntax and semantics, and proved
that our extended semantics are sound and complete,
and preserve deadlock-freedom
for well-formed protocols. 
We defined an encoding from the
canonical theory onto \newtheory, and proved the preservation
of well-formedness and communication.